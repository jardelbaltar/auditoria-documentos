<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Prot√≥tipo de Auditoria de Documentos</title>
  <style>
    :root {
      --bg: #10192d;
      --panel: #17243d;
      --text: #e4ebf7;
      --muted: #9aaac4;
      --surface-1: #16243d;
      --surface-2: #1b2a45;
      --surface-3: #15223a;
      --surface-4: #111b30;
      --table-head: #1d2d4a;
      --primary: #5a7fc8;
      --primary-soft: rgba(90, 127, 200, 0.2);
      --secondary: #5a7fc8;
      --accent: #6d8fd3;
      --border: rgba(149, 174, 220, 0.3);
      --chip-bg: rgba(109, 143, 211, 0.2);
      --chip-text: #d7e3fb;
      --chip-value-bg: rgba(34, 211, 238, 0.18);
      --chip-value-text: #67e8f9;
      --ins-bg: #d9f3e6;
      --ins-text: #1f5139;
      --del-bg: #f9d9df;
      --del-text: #7f1d2d;
      --shadow: 0 14px 32px rgba(1, 6, 20, 0.45);
      --radius: 14px;
    }

    :root[data-theme="light"] {
      --bg: #eef2f8;
      --panel: #f8fafc;
      --text: #0f172a;
      --muted: #475569;
      --surface-1: #ffffff;
      --surface-2: #ffffff;
      --surface-3: #f8fafc;
      --surface-4: #f1f5f9;
      --table-head: #eef2f7;
      --border: rgba(100, 116, 139, 0.35);
      --chip-bg: rgba(90, 127, 200, 0.14);
      --chip-text: #2f4775;
      --chip-value-bg: rgba(90, 127, 200, 0.2);
      --chip-value-text: #1f365f;
      --primary-soft: rgba(90, 127, 200, 0.16);
      --ins-bg: #d9f3e6;
      --ins-text: #1f5139;
      --del-bg: #f9d9df;
      --del-text: #7f1d2d;
      --shadow: 0 14px 32px rgba(15, 23, 42, 0.16);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--text);
      background: var(--bg);
      background-attachment: fixed;
    }
    h1,h2,h3,h4,p { margin: 0; }
    .muted { color: var(--muted); }

    .app {
      display: grid;
      grid-template-columns: 360px minmax(0, 1fr);
      gap: 14px;
      min-height: 100vh;
      padding: 14px;
    }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }

    .left {
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: calc(100vh - 28px);
    }
    .right {
      padding: 14px;
      overflow: auto;
      min-height: calc(100vh - 28px);
    }

    .main-frame {
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: calc(100vh - 56px);
    }

    .top-half {
      flex: 1;
      min-height: 0;
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(280px, 1fr);
      gap: 10px;
    }

    .left-stack {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
      overflow: auto;
      padding-right: 2px;
    }

    .current-version {
      min-height: 0;
    }

    .current-version .doc-html {
      min-height: 220px;
    }

    .title-block h1 { font-size: 1.08rem; }
    .title-block .muted { font-size: 0.84rem; margin-top: 2px; }

    .stack { display: flex; flex-direction: column; gap: 6px; }
    .row { display: flex; gap: 8px; align-items: center; }

    label { font-size: 0.82rem; color: var(--muted); }
    .input, select, button {
      border: 1px solid var(--border);
      border-radius: 9px;
      padding: 8px 10px;
      font-size: 0.85rem;
      background: var(--surface-2);
      color: var(--text);
    }
    .input, select { width: 100%; }
    button {
      cursor: pointer;
      font-weight: 600;
      transition: 0.2s ease;
    }
    button.primary {
      background: var(--primary);
      border-color: var(--primary);
      color: #f8fafc;
    }
    button.primary:hover { filter: brightness(1.1); }
    button.ghost:hover { background: rgba(38, 198, 255, 0.12); }

    .tour-launch {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .list {
      border: 1px solid var(--border);
      border-radius: 10px;
      max-height: 132px;
      overflow: auto;
      background: var(--surface-3);
    }
    .list-item {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      font-size: 0.84rem;
    }
    .list-item:last-child { border-bottom: none; }
    .list-item:hover { background: rgba(38, 198, 255, 0.08); }
    .list-item.active {
      background: var(--primary-soft);
      border-left: 3px solid var(--primary);
      padding-left: 7px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: var(--chip-bg);
      color: var(--chip-text);
      white-space: nowrap;
    }
    .chip .value {
      background: var(--chip-value-bg);
      border-radius: 999px;
      padding: 1px 6px;
      font-weight: 700;
      color: var(--chip-value-text);
    }
    .chip-wrap {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 10px 0 12px;
    }

    .preview-panel {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
      min-height: 280px;
    }
    .preview-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .preview-head h3 { font-size: 0.88rem; }
    .preview-meta { font-size: 0.76rem; color: var(--muted); }
    .doc-html {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      overflow: auto;
      background: var(--surface-4);
      font-size: 0.85rem;
      line-height: 1.35;
      height: 100%;
      min-height: 160px;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    .topbar h2 { font-size: 1rem; }
    .topbar .muted { font-size: 0.82rem; }

    .section {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      background: var(--surface-1);
      min-height: 0;
    }
    .section h3 { font-size: 0.88rem; margin-bottom: 8px; }

    details.section {
      padding: 0;
      overflow: hidden;
    }

    .section summary {
      list-style: none;
      cursor: pointer;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.88rem;
      font-weight: 600;
    }

    .section summary::-webkit-details-marker { display: none; }
    .section summary::after {
      content: "‚ñ∏";
      font-size: 0.8rem;
      color: var(--muted);
      transition: transform 0.2s ease;
    }
    details[open] > summary::after { transform: rotate(90deg); }

    .section-body {
      padding: 0 10px 10px;
    }

    .timeline-shell {
      max-height: 270px;
      overflow: auto;
      padding-right: 4px;
    }
    .timeline {
      border-left: 2px solid rgba(34, 211, 238, 0.5);
      margin-left: 8px;
      padding-left: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .timeline-item { position: relative; padding: 1px 0 3px; }
    .timeline-item::before {
      content: "";
      position: absolute;
      left: -17px;
      top: 5px;
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: var(--primary);
      box-shadow: 0 0 0 3px rgba(38, 198, 255, 0.2);
    }
    .timeline-action { font-size: 0.84rem; font-weight: 600; }
    .timeline-item .muted { font-size: 0.75rem; }
    .timeline-item button {
      margin-top: 4px;
      font-size: 0.74rem;
      padding: 4px 7px;
    }

    .table-wrap {
      max-height: 205px;
      overflow: auto;
      border: 1px solid var(--border);
      border-radius: 9px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      background: var(--surface-1);
    }
    th, td {
      border-bottom: 1px solid var(--border);
      padding: 7px;
      text-align: left;
      vertical-align: top;
      white-space: nowrap;
    }
    td:last-child { white-space: normal; }
    th {
      color: var(--muted);
      font-weight: 600;
      position: sticky;
      top: 0;
      background: var(--table-head);
    }
    tr:last-child td { border-bottom: none; }

    .bottom-half {
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }
    .compare-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 8px;
    }
    .diff-box {
      border: 1px solid var(--border);
      border-radius: 9px;
      padding: 8px;
      min-height: 110px;
      max-height: 200px;
      overflow: auto;
      font-size: 0.82rem;
    }
    .legend { font-size: .78rem; color: var(--muted); }
    .ins { background: var(--ins-bg); color: var(--ins-text); padding: 1px 3px; border-radius: 4px; }
    .del { background: var(--del-bg); color: var(--del-text); text-decoration: line-through; padding: 1px 3px; border-radius: 4px; }

    .tutorial-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.52);
      z-index: 999;
    }

    .tutorial-overlay.hidden,
    .tutorial-tooltip.hidden { display: none; }

    .tutorial-highlight {
      position: relative;
      z-index: 1001 !important;
      outline: 3px solid #f59e0b;
      border-radius: 10px;
      box-shadow: 0 0 0 6px rgba(245, 158, 11, 0.22);
      scroll-margin: 24px;
    }

    .tutorial-tooltip {
      position: fixed;
      max-width: 340px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 16px 36px rgba(2, 6, 23, 0.2);
      padding: 12px;
      z-index: 1002;
    }

    .tutorial-tooltip h4 { font-size: 0.92rem; margin-bottom: 6px; }
    .tutorial-tooltip p { font-size: 0.82rem; color: var(--muted); margin-bottom: 10px; line-height: 1.4; }
    .tutorial-progress { font-size: 0.74rem; color: var(--muted); margin-bottom: 8px; }
    .tutorial-actions {
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }
    .tutorial-actions button { flex: 1; }

    @media (max-width: 1160px) {
      .app { grid-template-columns: 1fr; }
      .left, .right { min-height: auto; }
      .preview-panel { min-height: 220px; }
      .top-half { grid-template-columns: 1fr; }
      .current-version {
        min-height: 220px;
      }
      .bottom-half { min-height: 280px; }
    }
  </style>
</head>
<body>
<div class="app">
  <aside class="panel left">
    <div class="title-block">
      <h1>Auditoria da Seguran√ßa da Informa√ß√£o</h1>
      <div class="muted">Painel tecnol√≥gico com foco em rastreabilidade, conformidade e risco</div>
    </div>

    <div class="stack">
      <label for="processSearch">Pesquisar processo</label>
      <input id="processSearch" class="input" placeholder="Ex.: 0001234-56.2025.8.26.0100" />
      <button id="searchBtn" class="primary">Buscar processo</button>
    </div>

    <div>
      <h3>Resultados de processos</h3>
      <div id="processList" class="list"></div>
    </div>

    <div class="stack">
      <label for="docTypeFilter">Filtrar por tipo de documento</label>
      <select id="docTypeFilter">
        <option value="todos">Todos</option>
        <option value="Decis√£o">Decis√£o</option>
        <option value="Despacho">Despacho</option>
        <option value="Voto">Voto</option>
      </select>
    </div>

    <div>
      <h3>Documentos do processo</h3>
      <div id="documentList" class="list"></div>
    </div>

  </aside>

  <main class="panel right">
    <div class="main-frame">
      <div>
        <div class="topbar">
          <div>
            <h2 id="headerTitle">Selecione um processo e documento</h2>
            <div id="headerSub" class="muted">Acompanhe timeline, permiss√µes, acessos e vers√µes</div>
          </div>
          <div class="row">
            <button id="themeBtn" class="ghost" title="Alternar tema">üåô Tema escuro</button>
            <button id="tutorialBtn" class="ghost tour-launch">‚ú® Tutorial guiado</button>
            <button id="exportBtn" class="ghost">Exportar auditoria (.md)</button>
          </div>
        </div>

        <div id="stats" class="chip-wrap"></div>
      </div>

      <div class="top-half">
        <div class="left-stack">
          <details class="section" open>
            <summary>Timeline de situa√ß√µes do documento</summary>
            <div class="section-body">
              <div class="timeline-shell">
                <div id="timeline" class="timeline"></div>
              </div>
            </div>
          </details>

          <details class="section">
            <summary>Permiss√µes atuais</summary>
            <div class="section-body">
              <div class="table-wrap">
                <table>
                  <thead>
                    <tr><th>Usu√°rio</th><th>Perfil</th><th>Permiss√µes</th></tr>
                  </thead>
                  <tbody id="permissionsTable"></tbody>
                </table>
              </div>
            </div>
          </details>

          <details class="section">
            <summary>Hist√≥rico de concess√µes/revoga√ß√µes</summary>
            <div class="section-body">
              <div class="table-wrap">
                <table>
                  <thead>
                    <tr><th>Data</th><th>Respons√°vel</th><th>Usu√°rio alvo</th><th>A√ß√£o</th><th>Permiss√£o</th></tr>
                  </thead>
                  <tbody id="grantHistoryTable"></tbody>
                </table>
              </div>
            </div>
          </details>

          <details class="section">
            <summary>Logs de acesso (fora da timeline)</summary>
            <div class="section-body">
              <div class="table-wrap">
                <table>
                  <thead>
                    <tr><th>Data</th><th>Usu√°rio</th><th>Evento</th><th>Detalhe</th></tr>
                  </thead>
                  <tbody id="accessLogsTable"></tbody>
                </table>
              </div>
            </div>
          </details>
        </div>

        <section class="preview-panel current-version">
          <div class="preview-head">
            <h3>√öltima vers√£o do documento</h3>
            <span id="leftPreviewVersion" class="chip">sem vers√£o</span>
          </div>
          <div id="leftPreviewMeta" class="preview-meta">Selecione um documento para visualizar o conte√∫do.</div>
          <div id="leftDocPreview" class="doc-html"></div>
        </section>
      </div>

      <section class="section bottom-half">
        <h3>Compara√ß√£o entre duas vers√µes</h3>
        <div class="row" style="margin-bottom: 8px; flex-wrap: wrap;">
          <select id="compareA"></select>
          <select id="compareB"></select>
          <button id="compareBtn" class="primary">Comparar vers√µes</button>
        </div>
        <div class="legend">Legenda: <span class="ins">inserido</span> <span class="del">removido</span></div>
        <div class="compare-grid">
          <div class="diff-box" id="compareLeft"></div>
          <div class="diff-box" id="compareRight"></div>
        </div>
      </section>
    </div>
  </main>
</div>

<div id="tutorialOverlay" class="tutorial-overlay hidden"></div>
<div id="tutorialTooltip" class="tutorial-tooltip hidden">
  <div id="tutorialProgress" class="tutorial-progress"></div>
  <h4 id="tutorialTitle"></h4>
  <p id="tutorialText"></p>
  <div class="tutorial-actions">
    <button id="tutorialPrev" class="ghost">Anterior</button>
    <button id="tutorialNext" class="primary">Pr√≥ximo</button>
    <button id="tutorialClose" class="ghost">Fechar</button>
  </div>
</div>

<script>
const data = {
  processes: [
    {
      id: "P1",
      number: "0001234-56.2025.8.26.0100",
      class: "Mandado de Seguran√ßa",
      documents: [
        buildDoc("D1", "Decis√£o", "Decis√£o Liminar", "Desembargadora Helena Costa"),
        buildDoc("D2", "Despacho", "Despacho de Intima√ß√£o", "Juiz Ricardo Teles")
      ]
    },
    {
      id: "P2",
      number: "1009876-11.2024.8.26.0001",
      class: "Apela√ß√£o C√≠vel",
      documents: [
        buildDoc("D3", "Voto", "Voto do Relator", "Desembargador Paulo Nogueira"),
        buildDoc("D4", "Decis√£o", "Decis√£o de M√©rito", "Ju√≠za Marina Freitas")
      ]
    },
    {
      id: "P3",
      number: "5023456-88.2023.8.26.0506",
      class: "Cumprimento de Senten√ßa",
      documents: [
        buildDoc("D5", "Despacho", "Despacho de Expedi√ß√£o", "Juiz Andr√© Lima")
      ]
    }
  ]
};

function buildDoc(id, type, title, author) {
  const base = {
    id,
    type,
    title,
    author,
    currentPermissions: [
      { user: "helena.costa", role: "Magistrado(a)", perms: ["gest√£o", "leitura", "escrita", "dele√ß√£o"] },
      { user: "ana.servidora", role: "Servidor(a)", perms: ["leitura", "escrita"] },
      { user: "gabinete.revisor", role: "Gabinete", perms: ["leitura"] }
    ],
    grantHistory: [
      { date: "2026-02-12 09:21", actor: "helena.costa", target: "ana.servidora", action: "Concedeu", permission: "escrita" },
      { date: "2026-02-12 09:22", actor: "helena.costa", target: "gabinete.revisor", action: "Concedeu", permission: "leitura" },
      { date: "2026-02-13 17:42", actor: "helena.costa", target: "ana.servidora", action: "Revogou", permission: "dele√ß√£o" }
    ],
    accessLogs: [
      { date: "2026-02-14 08:55", user: "ana.servidora", event: "Visualiza√ß√£o", detail: "Acesso via painel de minutas" },
      { date: "2026-02-14 09:30", user: "gabinete.revisor", event: "Impress√£o", detail: "Impress√£o em PDF para revis√£o" },
      { date: "2026-02-14 10:12", user: "helena.costa", event: "Visualiza√ß√£o", detail: "Consulta antes de assinar" }
    ],
    situations: [
      { date: "2026-02-10 10:05", status: "Cria√ß√£o", user: "ana.servidora", versionId: "v1" },
      { date: "2026-02-10 14:22", status: "Altera√ß√£o", user: "ana.servidora", versionId: "v2" },
      { date: "2026-02-11 11:03", status: "Preparo para assinatura", user: "ana.servidora", versionId: "v2" },
      { date: "2026-02-11 16:45", status: "Retirado da assinatura", user: "helena.costa", versionId: "v2" },
      { date: "2026-02-12 09:15", status: "Altera√ß√£o", user: "helena.costa", versionId: "v3" },
      { date: "2026-02-12 09:40", status: "Assinado", user: "helena.costa", versionId: "v3" },
      { date: "2026-02-12 11:10", status: "Enviado para publica√ß√£o", user: "sistema", versionId: "v3" },
      { date: "2026-02-13 07:40", status: "Publicado", user: "sistema", versionId: "v3" }
    ],
    versions: [
      {
        id: "v1",
        date: "2026-02-10 10:05",
        user: "ana.servidora",
        html: `<h2>${title}</h2><p>Vistos. Trata-se de an√°lise inicial do pedido formulado nos autos.</p><p>Defiro a tramita√ß√£o priorit√°ria.</p>`
      },
      {
        id: "v2",
        date: "2026-02-10 14:22",
        user: "ana.servidora",
        html: `<h2>${title}</h2><p>Vistos. Trata-se de an√°lise inicial do pedido formulado nos autos, com os documentos anexos.</p><p>Defiro a tramita√ß√£o priorit√°ria e determino intima√ß√£o da parte contr√°ria.</p>`
      },
      {
        id: "v3",
        date: "2026-02-12 09:15",
        user: "helena.costa",
        html: `<h2>${title}</h2><p>Vistos. Trata-se de an√°lise do pedido formulado nos autos, com documenta√ß√£o suficiente para aprecia√ß√£o.</p><p>Defiro parcialmente o pedido e determino intima√ß√£o da parte contr√°ria no prazo de 10 dias.</p><p>Publique-se. Intime-se.</p>`
      }
    ]
  };

  if (id === "D3") base.accessLogs.push({ date: "2026-02-15 09:11", user: "secretaria", event: "Visualiza√ß√£o", detail: "Confer√™ncia para pauta" });
  if (id === "D4") base.situations.splice(6, 0, { date: "2026-02-12 10:00", status: "Assinatura cancelada", user: "helena.costa", versionId: "v3" });
  return base;
}

const processList = document.getElementById("processList");
const documentList = document.getElementById("documentList");
const docTypeFilter = document.getElementById("docTypeFilter");
const leftPreviewVersion = document.getElementById("leftPreviewVersion");
const leftPreviewMeta = document.getElementById("leftPreviewMeta");
const leftDocPreview = document.getElementById("leftDocPreview");
const tutorialOverlay = document.getElementById("tutorialOverlay");
const tutorialTooltip = document.getElementById("tutorialTooltip");
const themeBtn = document.getElementById("themeBtn");
const THEME_STORAGE_KEY = "auditoria-theme";
let selectedProcess = null;
let selectedDocument = null;
let selectedVersionId = null;
let tutorialIndex = -1;
let highlightedEl = null;


function applyTheme(theme) {
  const resolvedTheme = theme === "light" ? "light" : "dark";
  document.documentElement.setAttribute("data-theme", resolvedTheme);
  themeBtn.textContent = resolvedTheme === "dark" ? "üåô Tema escuro" : "‚òÄÔ∏è Tema claro";
}

function initTheme() {
  const storedTheme = localStorage.getItem(THEME_STORAGE_KEY);
  const systemPrefersLight = window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches;
  applyTheme(storedTheme || (systemPrefersLight ? "light" : "dark"));
}

function toggleTheme() {
  const current = document.documentElement.getAttribute("data-theme") || "dark";
  const next = current === "dark" ? "light" : "dark";
  applyTheme(next);
  localStorage.setItem(THEME_STORAGE_KEY, next);
}

const tutorialSteps = [
  {
    selector: "#processSearch",
    title: "1) Pesquisa do processo",
    text: "Comece digitando o n√∫mero do processo. Em seguida, clique em 'Buscar processo' para carregar os resultados da consulta.",
    onEnter: () => {
      document.getElementById("processSearch").value = "0001234";
    }
  },
  {
    selector: "#processList",
    title: "2) Lista de resultados",
    text: "Aqui aparecem os processos encontrados. Clique em um item para habilitar os documentos vinculados no painel √† esquerda."
  },
  {
    selector: "#docTypeFilter",
    title: "3) Filtro por tipo",
    text: "Use este filtro para mostrar apenas Decis√£o, Despacho ou Voto, facilitando a auditoria por categoria documental."
  },
  {
    selector: "#documentList",
    title: "4) Documentos do processo",
    text: "Selecione um documento para carregar timeline, permiss√µes, logs e vers√µes compar√°veis no painel principal.",
    onEnter: () => ensureDemoSelection()
  },
  {
    selector: "#timeline",
    title: "5) Timeline do documento",
    text: "A timeline mostra os eventos cronol√≥gicos. Os bot√µes 'Abrir vX' permitem abrir rapidamente a vers√£o relacionada a cada evento.",
    onEnter: () => {
      document.querySelectorAll("details.section").forEach((detail, idx) => {
        if (idx === 0) detail.open = true;
      });
    }
  },
  {
    selector: "#leftDocPreview",
    title: "6) Visualiza√ß√£o da vers√£o",
    text: "Este quadro exibe o conte√∫do da vers√£o ativa. Ao clicar em um item da timeline, o texto √© atualizado aqui."
  },
  {
    selector: "#compareBtn",
    title: "7) Comparar vers√µes",
    text: "Escolha duas vers√µes nos seletores e clique em 'Comparar vers√µes' para ver trechos inseridos e removidos lado a lado."
  },
  {
    selector: "#exportBtn",
    title: "8) Exportar auditoria",
    text: "Quando finalizar a an√°lise, exporte um relat√≥rio .md com processo, timeline, permiss√µes, logs e vers√µes."
  }
];

function renderProcesses(filtered = data.processes) {
  processList.innerHTML = "";
  filtered.forEach((p) => {
    const item = document.createElement("div");
    item.className = "list-item" + (selectedProcess?.id === p.id ? " active" : "");
    item.innerHTML = `<strong>${p.number}</strong><br><span class="muted">${p.class}</span>`;
    item.onclick = () => {
      selectedProcess = p;
      selectedDocument = null;
      selectedVersionId = null;
      renderProcesses(filtered);
      renderDocuments();
      clearRight();
      clearPreview();
    };
    processList.appendChild(item);
  });
  if (!filtered.length) processList.innerHTML = `<div class="list-item muted">Nenhum processo encontrado.</div>`;
}

function renderDocuments() {
  documentList.innerHTML = "";
  if (!selectedProcess) return;
  const type = docTypeFilter.value;
  const docs = selectedProcess.documents.filter(d => type === "todos" || d.type === type);
  docs.forEach((d) => {
    const item = document.createElement("div");
    item.className = "list-item" + (selectedDocument?.id === d.id ? " active" : "");
    item.innerHTML = `<strong>${d.title}</strong><br><span class="chip">${d.type}</span>`;
    item.onclick = () => {
      selectedDocument = d;
      selectedVersionId = null;
      renderDocuments();
      renderRight();
    };
    documentList.appendChild(item);
  });
  if (!docs.length) documentList.innerHTML = `<div class="list-item muted">Sem documentos para o filtro selecionado.</div>`;
}

function clearPreview() {
  leftPreviewVersion.textContent = "sem vers√£o";
  leftPreviewMeta.textContent = "Selecione um documento para visualizar o conte√∫do.";
  leftDocPreview.innerHTML = "";
}

function clearRight() {
  document.getElementById("headerTitle").textContent = "Selecione um processo e documento";
  document.getElementById("headerSub").textContent = "Acompanhe timeline, permiss√µes, acessos e vers√µes";
  ["stats","timeline","permissionsTable","grantHistoryTable","accessLogsTable","compareA","compareB","compareLeft","compareRight"].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.innerHTML = "";
  });
}

function renderRight() {
  if (!selectedProcess || !selectedDocument) return;
  const d = selectedDocument;
  document.getElementById("headerTitle").textContent = `${selectedProcess.number} ‚Ä¢ ${d.title}`;
  document.getElementById("headerSub").textContent = `${d.type} | Autor principal: ${d.author}`;

  document.getElementById("stats").innerHTML = `
    <span class="chip">Situa√ß√µes registradas <span class="value">${d.situations.length}</span></span>
    <span class="chip">Vers√µes armazenadas <span class="value">${d.versions.length}</span></span>
    <span class="chip">Permiss√µes ativas <span class="value">${d.currentPermissions.length}</span></span>
    <span class="chip">Logs de acesso <span class="value">${d.accessLogs.length}</span></span>
  `;

  const timeline = document.getElementById("timeline");
  timeline.innerHTML = "";
  d.situations.forEach(s => {
    const item = document.createElement("div");
    item.className = "timeline-item";
    item.innerHTML = `<div class="timeline-action">${s.status}</div><div class="muted">${s.date} ‚Ä¢ ${s.user}</div>`;
    if (s.versionId) {
      const btn = document.createElement("button");
      btn.className = "ghost";
      btn.textContent = `Abrir ${s.versionId}`;
      btn.onclick = () => loadVersionById(s.versionId);
      item.appendChild(btn);
    }
    timeline.appendChild(item);
  });

  document.getElementById("permissionsTable").innerHTML = d.currentPermissions.map(p => `
    <tr><td>${p.user}</td><td>${p.role}</td><td>${p.perms.join(", ")}</td></tr>
  `).join("");

  document.getElementById("grantHistoryTable").innerHTML = d.grantHistory.map(g => `
    <tr><td>${g.date}</td><td>${g.actor}</td><td>${g.target}</td><td>${g.action}</td><td>${g.permission}</td></tr>
  `).join("");

  document.getElementById("accessLogsTable").innerHTML = d.accessLogs.map(l => `
    <tr><td>${l.date}</td><td>${l.user}</td><td>${l.event}</td><td>${l.detail}</td></tr>
  `).join("");

  const options = d.versions.map(v => `<option value="${v.id}">${v.id} ‚Ä¢ ${v.date} ‚Ä¢ ${v.user}</option>`).join("");
  document.getElementById("compareA").innerHTML = options;
  document.getElementById("compareB").innerHTML = options;

  loadVersionById(d.versions[d.versions.length - 1].id);
}

function loadVersionById(versionId) {
  if (!selectedDocument) return;
  const version = selectedDocument.versions.find(v => v.id === versionId);
  if (!version) return;
  selectedVersionId = versionId;
  leftPreviewVersion.textContent = version.id;
  leftPreviewMeta.textContent = `${version.date} ‚Ä¢ ${version.user}`;
  leftDocPreview.innerHTML = version.html;
}

function stripHTML(html) {
  const temp = document.createElement("div");
  temp.innerHTML = html;
  return temp.textContent || temp.innerText || "";
}

function diffWords(oldText, newText) {
  const a = oldText.split(/\s+/).filter(Boolean);
  const b = newText.split(/\s+/).filter(Boolean);
  const m = Array.from({length: a.length + 1}, () => Array(b.length + 1).fill(0));

  for (let i = a.length - 1; i >= 0; i--) {
    for (let j = b.length - 1; j >= 0; j--) {
      if (a[i] === b[j]) m[i][j] = m[i+1][j+1] + 1;
      else m[i][j] = Math.max(m[i+1][j], m[i][j+1]);
    }
  }

  let i = 0, j = 0;
  const left = [], right = [];
  while (i < a.length && j < b.length) {
    if (a[i] === b[j]) {
      left.push(a[i]);
      right.push(b[j]);
      i++; j++;
    } else if (m[i+1][j] >= m[i][j+1]) {
      left.push(`<span class="del">${a[i]}</span>`);
      i++;
    } else {
      right.push(`<span class="ins">${b[j]}</span>`);
      j++;
    }
  }
  while (i < a.length) left.push(`<span class="del">${a[i++]}</span>`);
  while (j < b.length) right.push(`<span class="ins">${b[j++]}</span>`);
  return { left: left.join(" "), right: right.join(" ") };
}

function compareSelected() {
  if (!selectedDocument) return;
  const aId = document.getElementById("compareA").value;
  const bId = document.getElementById("compareB").value;
  const aVer = selectedDocument.versions.find(v => v.id === aId);
  const bVer = selectedDocument.versions.find(v => v.id === bId);
  if (!aVer || !bVer) return;
  const result = diffWords(stripHTML(aVer.html), stripHTML(bVer.html));
  document.getElementById("compareLeft").innerHTML = `<strong>${aVer.id}</strong><hr>${result.left}`;
  document.getElementById("compareRight").innerHTML = `<strong>${bVer.id}</strong><hr>${result.right}`;
}

function exportAudit() {
  if (!selectedProcess || !selectedDocument) {
    alert("Selecione um processo e documento antes de exportar.");
    return;
  }
  const d = selectedDocument;
  const md = [
    `# Relat√≥rio de Auditoria de Documento`,
    ``,
    `## Processo`,
    `- N√∫mero: ${selectedProcess.number}`,
    `- Classe: ${selectedProcess.class}`,
    ``,
    `## Documento`,
    `- ID: ${d.id}`,
    `- T√≠tulo: ${d.title}`,
    `- Tipo: ${d.type}`,
    ``,
    `## Situa√ß√µes (timeline)`,
    ...d.situations.map(s => `- ${s.date} | ${s.status} | ${s.user} | vers√£o: ${s.versionId || "n/a"}`),
    ``,
    `## Permiss√µes atuais`,
    ...d.currentPermissions.map(p => `- ${p.user} (${p.role}): ${p.perms.join(", ")}`),
    ``,
    `## Hist√≥rico de concess√µes`,
    ...d.grantHistory.map(g => `- ${g.date} | ${g.actor} -> ${g.target} | ${g.action} ${g.permission}`),
    ``,
    `## Logs de acesso`,
    ...d.accessLogs.map(l => `- ${l.date} | ${l.user} | ${l.event} | ${l.detail}`),
    ``,
    `## Vers√µes salvas`,
    ...d.versions.map(v => `- ${v.id} | ${v.date} | ${v.user}`)
  ].join("\n");

  const blob = new Blob([md], { type: "text/markdown;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `auditoria-${selectedProcess.number}-${d.id}.md`;
  a.click();
  URL.revokeObjectURL(url);
}

document.getElementById("searchBtn").onclick = () => {
  const query = document.getElementById("processSearch").value.trim();
  const filtered = data.processes.filter(p => p.number.includes(query));
  selectedProcess = filtered[0] || null;
  selectedDocument = null;
  selectedVersionId = null;
  renderProcesses(filtered);
  renderDocuments();
  clearRight();
  clearPreview();
};

docTypeFilter.onchange = renderDocuments;
document.getElementById("compareBtn").onclick = compareSelected;
document.getElementById("exportBtn").onclick = exportAudit;
document.getElementById("tutorialBtn").onclick = startTutorial;
themeBtn.onclick = toggleTheme;
document.getElementById("tutorialPrev").onclick = prevTutorialStep;
document.getElementById("tutorialNext").onclick = nextTutorialStep;
document.getElementById("tutorialClose").onclick = stopTutorial;
window.addEventListener("resize", () => {
  if (tutorialIndex >= 0) showTutorialStep(tutorialIndex);
});

function ensureDemoSelection() {
  if (!data.processes.length) return;
  selectedProcess = data.processes[0];
  renderProcesses();
  renderDocuments();
  selectedDocument = selectedProcess.documents[0];
  renderDocuments();
  renderRight();
}

function clearTutorialHighlight() {
  if (highlightedEl) highlightedEl.classList.remove("tutorial-highlight");
  highlightedEl = null;
}

function startTutorial() {
  tutorialOverlay.classList.remove("hidden");
  tutorialTooltip.classList.remove("hidden");
  showTutorialStep(0);
}

function stopTutorial() {
  tutorialIndex = -1;
  tutorialOverlay.classList.add("hidden");
  tutorialTooltip.classList.add("hidden");
  clearTutorialHighlight();
}

function prevTutorialStep() {
  if (tutorialIndex <= 0) return;
  showTutorialStep(tutorialIndex - 1);
}

function nextTutorialStep() {
  if (tutorialIndex >= tutorialSteps.length - 1) {
    stopTutorial();
    return;
  }
  showTutorialStep(tutorialIndex + 1);
}

function showTutorialStep(index) {
  tutorialIndex = index;
  const step = tutorialSteps[index];
  if (!step) return;
  if (step.onEnter) step.onEnter();

  clearTutorialHighlight();
  const element = document.querySelector(step.selector);
  if (!element) return;
  highlightedEl = element;
  element.classList.add("tutorial-highlight");
  element.scrollIntoView({ behavior: "smooth", block: "center", inline: "nearest" });

  document.getElementById("tutorialProgress").textContent = `Passo ${index + 1} de ${tutorialSteps.length}`;
  document.getElementById("tutorialTitle").textContent = step.title;
  document.getElementById("tutorialText").textContent = step.text;
  document.getElementById("tutorialPrev").disabled = index === 0;
  document.getElementById("tutorialNext").textContent = index === tutorialSteps.length - 1 ? "Finalizar" : "Pr√≥ximo";

  const rect = element.getBoundingClientRect();
  const tooltipRect = tutorialTooltip.getBoundingClientRect();
  const margin = 12;

  let top = rect.bottom + margin;
  if (top + tooltipRect.height > window.innerHeight - margin) {
    top = rect.top - tooltipRect.height - margin;
  }
  top = Math.max(margin, top);

  let left = rect.left;
  if (left + tooltipRect.width > window.innerWidth - margin) {
    left = window.innerWidth - tooltipRect.width - margin;
  }
  left = Math.max(margin, left);

  tutorialTooltip.style.top = `${top}px`;
  tutorialTooltip.style.left = `${left}px`;
}

clearPreview();
initTheme();
renderProcesses();
</script>
</body>
</html>
